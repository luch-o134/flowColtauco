<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Stock - FlowColtauco</title>
    <link rel="stylesheet" href="agregarstock.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Header principal -->
    <div class="header">
        <div class="header-content">
            <!-- Panel Administrativo (izquierda) -->
            <div class="admin-title">
                <i class="fas fa-tachometer-alt"></i>
                Panel Administrativo
            </div>
            
            <!-- Usuario (centro) -->
            <div class="user-info">
                <i class="fas fa-user"></i>
                <span id="userName">admin</span>
            </div>
            
            <!-- Cerrar Sesión (derecha) -->
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </button>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="main-container">
        <div class="content-card">
            <h1><i class="fas fa-running"></i> Gestión de Zapatillas</h1>
            
            <!-- Formulario para agregar zapatilla -->
            <div class="form-section">
                <h2><i class="fas fa-plus"></i> Agregar Nueva Zapatilla</h2>
                <form id="addProductForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productMarca">Marca:</label>
                            <input type="text" id="productMarca" required placeholder="Ej: Nike, Adidas, Puma">
                        </div>
                        
                        <div class="form-group">
                            <label for="productModelo">Modelo:</label>
                            <input type="text" id="productModelo" required placeholder="Ej: Air Max 90">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productTalla">Talla:</label>
                            <input type="text" id="productTalla" required placeholder="39, 41-42, 9.5 US" pattern="[0-9\-\.\s]*" title="Ingrese la talla (números, guiones y puntos permitidos)">
                        </div>
                        
                        <div class="form-group">
                            <label for="productCantidad">Cantidad:</label>
                            <input type="number" id="productCantidad" required placeholder="10" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productPrecio">Precio (CLP):</label>
                            <input type="number" id="productPrecio" required placeholder="89990" step="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="productImagen">Imagen:</label>
                            <div class="file-input-container">
                                <input type="file" id="imageFile" accept="image/*" class="file-input">
                                <label for="imageFile" class="file-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span id="fileName">Seleccionar imagen...</span>
                                </label>
                                <div class="upload-status" id="uploadStatus"></div>
                                <input type="url" id="productImagen" placeholder="URL generada automáticamente..." readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista previa de la imagen -->
                    <div class="image-preview" id="imagePreview" style="display: none;">
                        <label>Vista previa:</label>
                        <img id="previewImg" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;">
                    </div>
                    
                    <button type="submit" class="btn-primary" id="submitBtn">
                        <i class="fas fa-plus"></i> Agregar Zapatilla
                    </button>
                </form>
            </div>

            <!-- Sección para actualizar stock -->
            <div class="form-section">
                <h2><i class="fas fa-edit"></i> Actualizar Stock Existente</h2>
                <form id="updateStockForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="existingProduct">Seleccionar Zapatilla:</label>
                            <select id="existingProduct" required>
                                <option value="">Cargando zapatillas...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="stockChange">Nueva Cantidad:</label>
                            <input type="number" id="stockChange" required placeholder="Ej: 25" min="0">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-secondary">
                        <i class="fas fa-sync"></i> Actualizar Stock
                    </button>
                </form>
            </div>

            <!-- Lista de zapatillas -->
            <div class="products-section">
                <h2>
                    <span class="section-title">
                        <i class="fas fa-list"></i> 
                        Zapatillas Actuales
                    </span>
                    <span class="section-actions">
                        <button onclick="loadProducts()" class="refresh-btn" id="refreshBtn">
                            Actualizar
                        </button>
                    </span>
                </h2>
                <div class="loading" id="loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Cargando zapatillas...
                </div>
                <div id="productsList">
                    <div class="info">
                        <i class="fas fa-info-circle"></i>
                        Haz clic en "Actualizar" para ver las zapatillas registradas
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🔥 Configuración de Supabase
        const SUPABASE_URL = 'https://fzyehmypypgahsdeeuru.supabase.co'
        const SUPABASE_ANON_KEY = 'sb_publishable_7ADTK4f_Wu-4Pb74x7BijQ_ncvgw4Ai'
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // API Key de ImgBB
        const IMGBB_API_KEY = '691e28b9ac88087badd99d0c4fcb461c';

        // Variables de cache
        let productsCache = null;
        let lastLoadTime = 0;
        const CACHE_DURATION = 30000; // 30 segundos

        // Cargar información del usuario
        document.addEventListener('DOMContentLoaded', function() {
            const adminUser = localStorage.getItem('admin_user');
            if (adminUser) {
                const user = JSON.parse(adminUser);
                document.getElementById('userName').textContent = user.username;
                
                // Cargar select de zapatillas sin cargar la tabla completa
                loadProductsForSelect();
            } else {
                window.location.href = 'administrador.html';
            }
        });

        // Manejar selección de archivo
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileName = document.getElementById('fileName');
            const uploadStatus = document.getElementById('uploadStatus');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const productImageInput = document.getElementById('productImagen');

            if (file) {
                fileName.textContent = file.name;
                
                // Mostrar vista previa inmediatamente
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);

                // Subir imagen automáticamente
                uploadImage(file);
            }
        });

        // Función optimizada para subir imagen
        async function uploadImage(file) {
            const uploadStatus = document.getElementById('uploadStatus');
            const productImageInput = document.getElementById('productImagen');
            const submitBtn = document.getElementById('submitBtn');

            // Validar tamaño de archivo (máximo 2MB)
            if (file.size > 2 * 1024 * 1024) {
                uploadStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Imagen muy grande (máx 2MB)';
                uploadStatus.className = 'upload-status error';
                return;
            }

            uploadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo imagen...';
            uploadStatus.className = 'upload-status uploading';
            submitBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);

                // Usar fetch con timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos timeout

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();

                if (data.success) {
                    productImageInput.value = data.data.url;
                    uploadStatus.innerHTML = '<i class="fas fa-check"></i> Imagen subida';
                    uploadStatus.className = 'upload-status success';
                } else {
                    throw new Error('Error al subir imagen');
                }
            } catch (error) {
                console.error('Error:', error);
                uploadStatus.innerHTML = '<i class="fas fa-info-circle"></i> Ingresa URL manualmente';
                uploadStatus.className = 'upload-status info';
                productImageInput.readOnly = false;
                productImageInput.placeholder = 'Ingresa URL de imagen...';
            } finally {
                submitBtn.disabled = false;
            }
        }

        // Agregar nueva zapatilla (optimizado)
        document.getElementById('addProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
            submitBtn.disabled = true;

            try {
                const productData = {
                    marca: document.getElementById('productMarca').value.trim(),
                    modelo: document.getElementById('productModelo').value.trim(),
                    talla: document.getElementById('productTalla').value.trim(),
                    cantidad: parseInt(document.getElementById('productCantidad').value),
                    precio: parseFloat(document.getElementById('productPrecio').value),
                    imagen: document.getElementById('productImagen').value.trim() || null
                };

                const { error } = await supabase
                    .from('zapatillas')
                    .insert([productData]);

                if (error) throw error;

                // Limpiar formulario
                document.getElementById('addProductForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('fileName').textContent = 'Seleccionar imagen...';
                document.getElementById('uploadStatus').innerHTML = '';
                document.getElementById('productImagen').readOnly = true;
                document.getElementById('productImagen').placeholder = 'URL generada automáticamente...';

                // Invalidar cache y actualizar select
                productsCache = null;
                await loadProductsForSelect();

                alert('Zapatilla agregada exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Actualizar stock (optimizado)
        document.getElementById('updateStockForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('existingProduct').value;
            const newStock = parseInt(document.getElementById('stockChange').value);
            const submitBtn = e.target.querySelector('button');
            const originalText = submitBtn.innerHTML;

            if (newStock < 0) {
                alert('La cantidad no puede ser negativa');
                return;
            }

            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
            submitBtn.disabled = true;

            try {
                const { error } = await supabase
                    .from('zapatillas')
                    .update({ cantidad: newStock })
                    .eq('id', productId);

                if (error) throw error;

                // Invalidar cache y actualizar
                productsCache = null;
                document.getElementById('updateStockForm').reset();
                await loadProductsForSelect();

                alert('Stock actualizado exitosamente');
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Cargar zapatillas optimizado (solo cuando se necesite)
        async function loadProducts() {
            const loading = document.getElementById('loading');
            const productsList = document.getElementById('productsList');
            const refreshBtn = document.getElementById('refreshBtn');
            
            // Verificar cache
            const now = Date.now();
            if (productsCache && (now - lastLoadTime) < CACHE_DURATION) {
                console.log('Usando cache...');
                displayProducts(productsCache);
                return;
            }

            loading.style.display = 'block';
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshBtn.disabled = true;

            try {
                const { data: products, error } = await supabase
                    .from('zapatillas')
                    .select('id, marca, modelo, talla, cantidad, precio, imagen, created_at')
                    .order('created_at', { ascending: false })
                    .limit(50); // Limitar a 50 registros

                if (error) throw error;

                // Actualizar cache
                productsCache = products;
                lastLoadTime = now;

                displayProducts(products);
            } catch (error) {
                console.error('Error:', error);
                productsList.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            } finally {
                loading.style.display = 'none';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
                refreshBtn.disabled = false;
            }
        }

        // Función separada para mostrar productos
        function displayProducts(products) {
            const productsList = document.getElementById('productsList');

            if (products.length === 0) {
                productsList.innerHTML = '<p class="no-products">No hay zapatillas registradas</p>';
                return;
            }

            const table = `
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Imagen</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Talla</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td>${product.id}</td>
                                <td>
                                    ${product.imagen ? 
                                        `<img src="${product.imagen}" alt="Imagen" loading="lazy" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">` 
                                        : '<span class="no-image">Sin imagen</span>'
                                    }
                                </td>
                                <td><span class="category-badge">${product.marca}</span></td>
                                <td>${product.modelo}</td>
                                <td>${product.talla}</td>
                                <td>$${product.precio ? product.precio.toLocaleString('es-CL') : 'N/A'}</td>
                                <td><span class="stock-badge ${product.cantidad < 5 ? 'low-stock' : ''}">${product.cantidad}</span></td>
                                <td>
                                    <button onclick="deleteProduct(${product.id})" class="btn-danger btn-sm">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            productsList.innerHTML = table;
        }

        // Cargar solo para el select (más rápido)
        async function loadProductsForSelect() {
            try {
                const { data: products, error } = await supabase
                    .from('zapatillas')
                    .select('id, marca, modelo, talla, cantidad')
                    .order('marca')
                    .limit(100); // Limitar cantidad

                if (error) throw error;

                const select = document.getElementById('existingProduct');
                select.innerHTML = '<option value="">Seleccionar zapatilla</option>';
                
                products.forEach(product => {
                    select.innerHTML += `<option value="${product.id}">${product.marca} ${product.modelo} - Talla ${product.talla} (Stock: ${product.cantidad})</option>`;
                });

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('existingProduct').innerHTML = '<option value="">Error al cargar</option>';
            }
        }

        // Eliminar producto (corregido)
        async function deleteProduct(productId, buttonElement = null) {
            if (confirm('¿Estás seguro de que quieres eliminar esta zapatilla?')) {
                let deleteBtn = buttonElement;
                let originalText = '';
                
                // Si no se pasa el botón, intentar encontrarlo
                if (!deleteBtn) {
                    deleteBtn = document.querySelector(`button[onclick="deleteProduct(${productId})"]`);
                }
                
                if (deleteBtn) {
                    originalText = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    deleteBtn.disabled = true;
                }

                try {
                    console.log('Intentando eliminar producto con ID:', productId);
                    
                    const { error } = await supabase
                        .from('zapatillas')
                        .delete()
                        .eq('id', productId);

                    if (error) {
                        console.error('Error de Supabase:', error);
                        throw error;
                    }

                    console.log('Producto eliminado exitosamente');
                    
                    // Invalidar cache y recargar
                    productsCache = null;
                    await Promise.all([loadProducts(), loadProductsForSelect()]);
                    
                    alert('Zapatilla eliminada exitosamente');
                } catch (error) {
                    console.error('Error completo:', error);
                    alert('Error al eliminar: ' + error.message);
                    
                    // Restaurar botón en caso de error
                    if (deleteBtn) {
                        deleteBtn.innerHTML = originalText;
                        deleteBtn.disabled = false;
                    }
                }
            }
        }

        function logout() {
            localStorage.removeItem('admin_user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>